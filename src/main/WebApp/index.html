<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>
    <title>Hello WebSocket</title>
    <!--    <script src="/webjars/jquery/dist/jquery.min.js"></script>-->
    <!--    <script src="/webjars/sockjs-client/sockjs.min.js"></script>-->
    <!--    <script src="/webjars/stomp-websocket/stomp.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <!--    libs for stomp and sockjs-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <!--    end libs for stomp and sockjs-->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet"
          type="text/css">
</head>
<body>
<div id="main-content">
    <script>
        $.get('http://localhost:8080/messages/currentUser', function (response) {
            console.log(response)
            connect(response);
        })
    </script>
    <form>
        <div class="mb-1"><label class="row justify-content-between"> Text: <input class="mt-1" type="text" name="text" id="text" required autofocus></label></div>
        <div class="mb-1"><label class="row justify-content-between"> to User: <input class="mt-1" type="text" name="to_user" required autofocus/> </label></div>

        <div class="text-center"><button class="btn btn-primary mt-3" type="submit" id="send">Send</button></div>
    </form>
    <script>
        from = $.get('http://localhost:8080/messages/currentUser', function (response) {
            return  response;
        })
        $("#send").click(function() {
            sendMsg($("#to_user").val(), from, $("#text").val());
        });

    </script>
    <!--    <div>-->
    <!--        <div>-->
    <!--            <label>What is your username?</label>-->
    <!--            <input type="text" id="username" placeholder="Your username here...">-->
    <!--        </div>-->
    <!--        <button id="connect" type="submit">Connect</button>-->
    <!--        <form>-->
    <!--            <div>-->
    <!--                <label>User will received message</label>-->
    <!--                <input type="text" id="name" placeholder="User will receive the message...">-->
    <!--            </div>-->
    <!--            <button id="send" type="submit">Send</button>-->
    <!--        </form>-->
    <!--    </div>-->
</div>
<div>
    <label>Message from someone: </label><span id="message"></span>
</div>
<script>
    var stompClient = null;

    function connect(username) {
        var socket = new SockJS('/chat');
        console.log(socket);
        stompClient = Stomp.over(socket);
        console.log();
        stompClient.connect({ username: username }, function() {
            console.log('Web Socket is connected');
            stompClient.subscribe('/topic/messages/' + username, function(response) {
                let data = JSON.parse(response.body);
                console.log(data.toString())
            });
        });
    }

    function sendMsg(to, from, text) {
        stompClient.send("/app/chat/" + to, {}, JSON.stringify({
            fromUsername:from,
            message:text
        }))
    }
    // $(function() {
    //     // $("form").on('submit', function(e) {
    //     //     e.preventDefault();
    //     // });
    //     //$("#login").click(function() {
    //         connect($("#username").val());
    //
    //     //});
    //     // $("#send").click(function() {
    //     //     stompClient.send("/qwa/app/hello", {}, $("#name").val());
    //     // });
    // });
</script>
</body>
</html>