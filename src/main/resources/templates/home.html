<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org">
<head>
    <title>Hello WebSocket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.0/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.1.1/list.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet"
          type="text/css">
</head>
<body class="bg-dark text-white-50">
<div id="main-content">
    <form class="container-md" style="max-width: 500px;">
        <div class="mb-1"><label class="row justify-content-between"> Text: <textarea class="mt-1" name="text" id="text" required autofocus> </textarea></label></div>
        <div class="mb-1"><label class="row justify-content-between"> to User: <input class="mt-1" type="text" name="to_user" id="to_user" required autofocus/> </label></div>

        <div class="text-center"><button class="btn btn-primary mt-3" type="submit" id="send">Send</button></div>
    </form>
</div>
<div class="m-4">
    <h4><label>Your Messages: </label><span id="message"></span></h4>
    <div class="accordion" id="messages_list" style="color: black; max-width: 900px;">
        <div class="accordion-item" th:each="message : ${messages}">
            <h2 class="accordion-header" th:id="'heading'+${message.id}">
                <button class="accordion-button collapsed" style="background-color: lightskyblue;" type="button" data-bs-toggle="collapse" th:data-bs-target="'#collapse'+${message.id}" aria-expanded="false" th:aria-controls="'collapse'+${message.id}">
                    <div th:text="'From: ' + ${message.fromUsername}"></div>
                    <div th:text="', Sended: ' + ${message.date}"></div>
                </button>
            </h2>
            <div th:id="'collapse'+${message.id}" class="accordion-collapse collapse" th:aria-labelledby="'heading'+${message.id}" data-bs-parent="#messages_list">
                <div class="accordion-body" th:text="${message.text}">
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var stompClient = null;
    var num = 0

   // const url = "https://ryannel-task4.herokuapp.com/"
    const url = 'http://localhost:8080/'

    $.get(url + 'currentUser', function (response) {
        console.log(response)
        connect(response);
    });

    var from;
    $.get(url + 'currentUser', function (response) {
        from = response;
    });

    $("#send").click(function() {
        console.log($("#to_user"))
        console.log(from)
        console.log($("#text").val())
        sendMsg($("#to_user").val(), from, $("#text").val());
    });

    function connect(username) {
        var socket = new SockJS('/chat');
        console.log(socket);
        stompClient = Stomp.over(socket);
        console.log();
        stompClient.connect({ username: username }, function() {
            console.log('Web Socket is connected');
            stompClient.subscribe('/topic/messages/' + username, function(response) {
                let data = JSON.parse(response.body);
                console.log("qwa")
                var templateResponse = Handlebars.compile($("#message-template").html());
                var contextResponse = {
                    message: data.message,
                    time: new Date().toLocaleString(),
                    userName: data.fromUsername
                };
                    var list = document.getElementById('messages_list')
                    var firstLi = list.childNodes[0]
                    var newListElem = document.createElement('div')
                    newListElem.innerHTML = templateResponse(contextResponse)

                    list.insertBefore(newListElem, firstLi)
                    num -= 1
            });
        });
    }

    function sendMsg(to, from, text) {
        console.log(to)
        console.log(from)
        console.log(text)

        stompClient.send("/app/chat/" + to, {}, JSON.stringify({
            fromUsername:from,
            message:text
        }));
    }

</script>
<script id="message-template" type="text/x-handlebars-template">
    <div class="accordion-item">
        <h2 class="accordion-header" th:id="'heading'+num">
            <button class="accordion-button collapsed" style="background-color: lightskyblue;" type="button" data-bs-toggle="collapse" th:data-bs-target="'#collapse'+num" aria-expanded="false" th:aria-controls="'collapse'+num">
                <div>From: {{userName}}</div>
                <div>, Sended: {{time}}</div>
            </button>
        </h2>
        <div th:id="'collapse'+num" class="accordion-collapse collapse" th:aria-labelledby="'heading'+num" data-bs-parent="#messages_list">
            <div class="accordion-body">
                {{message}}
            </div>
        </div>
    </div>
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>